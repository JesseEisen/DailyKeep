---
title: C library Use
updated: 2017-04-05  16:21
---

C语言中，想要打印函数调用栈，有两种不错的方式，一个是调用linux的接口函数，一个是自己构造函数，两者都有相应的利弊所在，下面就描述一下这两者的实现。

## linux接口

linux中提供了`backtrace`函数的接口，包含在`<execinfo.h>` 中，要打印出backtrace的信息一般还要配合另外一个函数，`backtrace_symbols` 具体的两个函数的使用如下：

```
nlevel = backtrace(buffer,size);
strings = backtrace_symbols(buffer,nlevel);
```

buffer是用来保存backtrace信息的，size是表示需要保存堆栈的深度。nlevel是表示真实返回的堆栈深度。
strings是转换后的堆栈信息，可以直接用于打印，这是一个字符串数组。

在编译的时候，如果想输出详细的函数信息，需要添加`-rdynamic` 标记。


同时需要注意的是，加上了这个标记后，所打印出来的函数名不包含用`static`修饰的函数。 因此这一点在使用上会有点局限性，但是总体上对于输出堆栈信息还是很方便的。

## 自定义宏

可以利用`__FUNCTION__`等宏来构造一个自己的堆栈信息打印宏。

```
#ifdef NDBUG
#define NL_RETURN(rc)  return (rc)
#else
#define NL_RETURN(rc) { \
	if((rc)) { \
				fprintf(stderr, "Error(code: %d) at: %s(%s:%d)\n",(rc), __FUNCTION__, __FILE__,__LINE__);\
					}\
						return (rc); \
}\
```

使用方式如下：

```
int function1(void){
	int ret = function2();
	if(ret)  NL_RETURN(ret);

	NL_RETURN(0);
}

```

这会在连续调用的情况下，某个函数出错后，会逐个的返回并打印。这个方式的弊端在于，在每个需要追踪的函数中都要添加逐个宏，会显得略微的冗余。

